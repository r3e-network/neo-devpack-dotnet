name: Debug Release Build

on:
  workflow_dispatch:
  push:
    branches:
      - r3e

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Check environment
      run: |
        echo "ğŸ” Environment Information"
        echo "========================"
        echo "Runner: ${{ runner.os }}"
        echo "Ref: ${{ github.ref }}"
        echo "SHA: ${{ github.sha }}"
        echo "Event: ${{ github.event_name }}"
        echo ""
        echo "ğŸ“ Working Directory:"
        pwd
        echo ""
        echo "ğŸ“‚ Directory Contents:"
        ls -la
        echo ""
        echo "ğŸ·ï¸ Git Tags:"
        git tag -l
        echo ""
        echo "ğŸŒ¿ Git Branch:"
        git branch -a
        echo ""
        echo "ğŸ“ Release Files:"
        ls -la | grep -E "(RELEASE_NOTES|CHANGELOG|MIGRATION|QUICK_START)" || echo "No release files found"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Check .NET
      run: |
        echo "ğŸ”§ .NET Information"
        echo "=================="
        dotnet --version
        dotnet --list-sdks
        dotnet --list-runtimes

    - name: Test restore
      run: |
        echo "ğŸ“¦ Testing dotnet restore..."
        dotnet restore --verbosity normal

    - name: Test build
      run: |
        echo "ğŸ”¨ Testing dotnet build..."
        dotnet build -c Release --no-restore --verbosity normal || {
          echo "âŒ Build failed!"
          echo "Checking for common issues..."
          find . -name "*.csproj" -exec echo "Project: {}" \; -exec grep -E "(PackageIcon|PackageReadme)" {} \;
          exit 1
        }

    - name: Test pack
      run: |
        echo "ğŸ“¦ Testing dotnet pack..."
        dotnet pack -c Release --no-build -o ./test-nupkgs --verbosity normal || {
          echo "âŒ Pack failed!"
          exit 1
        }
        echo ""
        echo "ğŸ“Š Packages created:"
        ls -la ./test-nupkgs/*.nupkg | grep -v snupkg || echo "No packages found"

    - name: Check icon files
      run: |
        echo "ğŸ–¼ï¸ Checking icon files..."
        find . -name "icon.png" -type f -exec ls -la {} \;

    - name: Check README files
      run: |
        echo "ğŸ“„ Checking README files..."
        find . -name "README.md" -type f | head -20

    - name: Summary
      if: always()
      run: |
        echo "## ğŸ“‹ Debug Summary"
        echo ""
        echo "### Environment"
        echo "- .NET Version: $(dotnet --version)"
        echo "- OS: ${{ runner.os }}"
        echo "- Ref: ${{ github.ref }}"
        echo ""
        echo "### Build Status"
        echo "âœ… Completed debug workflow"